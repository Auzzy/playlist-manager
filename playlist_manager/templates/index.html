{% extends "layout.html" %}

{% block body %}
<div class="container mt-3">
    <div class="row">
        <div class="col">
            <h2>Playlists</h2>
        </div>
    </div>
    <div class="row">
        <div class="input-group col-5 mb-3">
            <input type="text" class="form-control" id="artist-name" placeholder="Artist...">
            <div class="input-group-append">
                <button id="create-playlist-button" type="button" class="btn btn-primary">Create Playlist</button>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col">
            <div id="playlist-list" class="list-group">
            {% for playlist in playlists %}
            <a href="{{ url_for('display_playlist', id=playlist['id']) }}" class="list-group-item list-group-item-action">{{ playlist['name'] }}</a>
            {% endfor %}
            </div>
        </div>
    </div>
</div>

<div id="modal-artist-disambiguation" class="modal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Artist Disambiguation</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Found more than one match for &quot;<span id="modal-artist-name"></span>&quot;. Please select one:</p>
                <div id="modal-artist-choices" class="list-group"></div>
            </div>
        </div>
    </div>
</div>

{% include "login-modal.html" %}
{% endblock %}

{% block css %}
.loader {
    margin-left: 5px;
}
{% endblock %}

{% block js %}
function appendPlaylist(playlist) {
    $("#playlist-list")
        .append($("<a></a>")
            .addClass("list-group-item list-group-item-action")
            .attr("href", "#")
            .attr("data-playlist-id", playlist["id"])
            .text(playlist["name"]));
}

function loadPlaylists() {
    return $.post("{{ url_for('show_playlists') }}")
        .done(function(response) {
            $("#playlist-list").empty();

            response["playlists"].forEach(appendPlaylist);
        })
        .fail(function(jqXHR, textStatus, errorThrown) {
            openLoginOnUnauth(jqXHR, loadPlaylists);
        });
}

function createPlaylist() {
    $("#create-playlist-button")
        .append($("<i></i>")
            .addClass("loader fas fa-circle-notch fa-spin fa-sm"));

    $.post("{{ url_for('create_playlist') }}", {artistName: $("#artist-name").val()})
        .done(function(response) {
            if (response.hasOwnProperty("created")) {
                loadPlaylists()
                    .done(function() {
                        // Reset inputs
                        $("#artist-name").val("");
                        $("#create-playlist-button .loader").remove();
                    });
            } else {
                // If multiple artists were found for the search term, setup and
                // open the disambiguation modal.
                $("#modal-artist-choices").empty();

                $("#modal-artist-name").text(response["artist"]);
                response["choices"].forEach(choice => {
                    var label = choice["name"];
                    if (choice["disambiguation"]) {
                        label += ` (${choice["disambiguation"]})`;
                    }
                    $("#modal-artist-choices")
                        .attr("data-search", response["artist"])
                        .append($("<a></a>")
                            .addClass("list-group-item list-group-item-action")
                            .attr("href", "#")
                            .attr("data-artist-id", choice["id"])
                            .css("cursor", "pointer")
                            .text(label));
                });

                $("#modal-artist-disambiguation").modal();
            }
        })
        .fail(function(jqXHR, textStatus, errorThrown) {
            openLoginOnUnauth(jqXHR, createPlaylist);
            $("#create-playlist-button .loader").remove();
        });
}

function createPlaylistSelectArtist(node) {
    if ($(node).hasClass("disabled")) {
        event.stopImmediatePropagation();
        event.stopPropagation();
        event.preventDefault();
        return;
    }

    $("#modal-artist-choices .list-group-item")
        .addClass("disabled");

    $(node)
        .append($("<i></i>")
            .addClass("loader fas fa-circle-notch fa-spin fa-sm"));

    $.post("{{ url_for('create_playlist') }}", {artistName: $(node).parent().attr("data-search"), artistId: $(node).attr("data-artist-id")})
        .done(function() {
            loadPlaylists()
                .done(function() {
                    $("#modal-artist-disambiguation").modal("hide");

                    // Reset inputs
                    $("#artist-name").val("");
                    $("#modal-artist-name").empty();
                    $("#modal-artist-choices")
                        .empty()
                        .removeAttr("data-search");
                    $(node).remove(".loader");
                    $("#create-playlist-button .loader").remove();
                });
        })
        .fail(function(jqXHR, textStatus, errorThrown) {
            openLoginOnUnauth(jqXHR, () => createPlaylistSelectArtist(node));
            $("#modal-artist-choices .loader").remove();
            $("#modal-artist-choices .list-group-item")
                .removeClass("disabled");
        });
}

$("#create-playlist-button").click(function(event) {
    createPlaylist();
});

$("#modal-artist-choices").on("click", ".list-group-item", function() {
    createPlaylistSelectArtist(this);
});

$("#playlist-list").on("click", ".list-group-item", function() {
    window.location.href = "{{ url_for('display_playlist') }}?id=" + $(this).attr("data-playlist-id");
});

$("#modal-artist-disambiguation").on("hide.bs.modal", function() {
    $("#create-playlist-button .loader").remove();
    $("#modal-artist-choices").empty();
});

loadPlaylists();

{% include "js/login.html" %}

{% endblock %}
