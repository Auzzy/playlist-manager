{% extends "layout.html" %}

{% block body %}
<div style="margin: 50px;">
    <button id="playlist-save" type="button" class="btn btn-primary" disabled>Save</button>
    <button id="playlist-undo" type="button" class="btn btn-primary" disabled>Undo</button>
    <button id="playlist-reset" type="button" class="btn btn-primary" disabled>Reset</button>
    <button id="playlist-delete" type="button" class="btn btn-primary" disabled>Delete Selected <span id="delete-count"></span></button>
    <ul id="playlist-tracks" data-playlist-id="{{ playlist_id }}" class="list-group" style="max-width: 50%">
    {% for track in tracks %}
    <li data-id="{{ track['item_id'] }}" data-name="{{ track['name'] }}" data-artist="{{ track['artist'] }}" data-album="{{ track['album'] }}" class="list-group-item"></li>
    {% endfor %}
    </ul>
</div>

{% endblock %}

{% block css %}
#playlist-tracks {
    cursor: move;
}
.selected {
	background-color: #f9c7c8;
	border: solid red 1px !important;
	z-index: 1 !important;
}
{% endblock %}

{% block js %}
var changes = [];

function arrayEq(array1, array2) {
    return array1.length === array2.length && array1.every((value, index) => value === array2[index]);
}

function arrayZip(...arrays) {
    var final = arrays[0].map(val => [val]);
    arrays.slice(1).forEach(arr => arr.forEach((val, index) => final[index].push(val)));
    return final;
}

function toggleAttr(condition, selector, attrName) {
    if (condition) {
        $(selector).attr(attrName, attrName);
    } else {
        $(selector).removeAttr(attrName);
    }
}

function getPlaylistTracks() {
    var tracks = [];
    $("#playlist-tracks li").each((index, val) => tracks.push($(val).attr("data-id")));
    return tracks;
}

function redisplayTracks() {
    $("#playlist-tracks li").each((index, item) => {
        var name = $(item).attr("data-name");
        var artist = $(item).attr("data-artist");
        var album = $(item).attr("data-album");
        $(item).html(`${index + 1}. ${name} - <span style="font-size: 80%; color: rgb(128,128,128);">by ${artist} (from ${album})</span><span class="oi oi-trash float-right" style="cursor: pointer;"></span>`);
    });
    $("#playlist-tracks li .oi-trash")
        .click(function() {
            deleteTracks($(this).parent('li'));
        });
}

function undoLastAction() {
    var lastAction = changes[changes.length - 1];
    if (lastAction[0] === "move") {
        var itemToDest = lastAction.slice(1).map(move => [$(`#playlist-tracks li[data-id='${move[0]}']`).detach(), move[1]]);
        itemToDest.sort((val1, val2) => val2[1] > val1[1]);
        itemToDest.forEach(([item, index]) => $(`#playlist-tracks li:nth(${index})`).before(item));
        changes.splice(changes.length - 1, 1);
    } else if (lastAction[0] === "delete") {
        var itemToDest = lastAction.slice(1);
        itemToDest.sort((val1, val2) => val2[1] > val1[1]);
        itemToDest.forEach(([item, index]) => $(`#playlist-tracks li:nth(${index})`).before(item));
        changes.splice(changes.length - 1, 1);
    }
    updateActionButtons();
}

function updateActionButtons() {
    toggleAttr(arrayEq(originalTracks, getPlaylistTracks()), "#playlist-save", "disabled");
    toggleAttr(!changes.length, "#playlist-undo", "disabled");
    toggleAttr(!changes.length, "#playlist-reset", "disabled");
    toggleAttr(!$("#playlist-tracks li.selected").length, "#playlist-delete", "disabled");
}

function updateSelectedCount() {
    var selectedCount = $("#playlist-tracks li.selected").length;
    $("#delete-count").text(selectedCount === 0 ? "" : `(${selectedCount})`);
}

function deleteTracks(nodeList) {
    var deleted = ["delete"];
    $(nodeList)
        .removeClass("selected")
        .each((index, node) => {
            deleted.push([node, $(node).index()]);
        })
        .detach();
    changes.push(deleted);
    updateActionButtons();
}

$("#playlist-save").click(function() {
    $.post("{{ url_for('save_playlist', id=playlist_id) }}", {tracks: JSON.stringify(getPlaylistTracks())})
        .done(function() {
            redisplayTracks();
            changes = [];
        });
});

$("#playlist-undo").click(function() {
    if (changes.length) {
        undoLastAction();
        updateActionButtons();
    }
});

$("#playlist-reset").click(function() {
    while (changes.length) {
        undoLastAction();
    }
    updateActionButtons();
});

$("#playlist-delete").click(function() {
    deleteTracks($("#playlist-tracks li.selected"));
});

$("#playlist-tracks li").click(event => {
    var clicked = $(event.target).closest("li");
    if (clicked.hasClass("selected")) {
        if (event.ctrlKey) { 
            clicked.removeClass("selected");
        }
    } else {
        if (event.ctrlKey) {
            clicked.addClass("selected");
        } else {
            $("#playlist-tracks li").removeClass("selected");
            clicked.addClass("selected");
        }
    }
    updateActionButtons();
});


new Sortable($("#playlist-tracks").get(0), {
	multiDrag: true,
    multiDragKey: "Ctrl",
	fallbackTolerance: 3, // So that we can select items on mobile
	animation: 150,
    onUpdate: function (evt) {
        if (evt.items.length) {
            var moveInfo = arrayZip(
                evt.items.map(item => $(item).attr("data-id")),
                evt.oldIndicies.map(info => info["index"]),
                evt.newIndicies.map(info => info["index"]));
        } else {
            var moveInfo = [[$(evt.item).attr("data-id"), evt.oldIndex, evt.newIndex]];
        }

        moveInfo.splice(0, 0, "move");

        changes.push(moveInfo);
        console.log(JSON.stringify(changes));

        updateActionButtons();
    }
});


var mutationObserver = new MutationObserver(function(mutations, mut) {
    updateSelectedCount();
});

$("#playlist-tracks li").each((index, node) => {
    mutationObserver.observe(node, {"attributeFilter": ["class"]});
});


var originalTracks = getPlaylistTracks();
redisplayTracks();
{% endblock %}
